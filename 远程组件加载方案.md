# 通用远程组件加载方案（CDN 版）

## 一、原理

利用酒馆助手插件对 Markdown 代码块的渲染能力，通过正则替换注入一段"通用加载器"代码。该加载器使用 jQuery 的 `load()` 方法，从 jsDelivr CDN 镜像站拉取任意 HTML 组件代码，并注入到页面中执行。

### 酒馆助手渲染触发条件

代码块内容必须包含以下**任意一个**字符串才会被识别为前端代码：

| 触发字符串 | 示例                             |
| ---------- | -------------------------------- |
| `html>`    | `<html>` 或 `</html>`            |
| `<head>`   | `<head>`                         |
| `<body`    | `<body>` 或 `<body class="...">` |

> **核心代码**（来自 `src/util/is_frontend.ts`）：
>
> ```typescript
> export function isFrontend(content: string) {
>   return ["html>", "<head>", "<body"].some((tag) => content.includes(tag));
> }
> ```

---

## 二、准备工作

### 1. 组件代码处理

| 原始格式                                            | 处理方式                                                 |
| --------------------------------------------------- | -------------------------------------------------------- |
| **完整 HTML**（有 `<html>` 标签）                   | 建议删除 `<html>` 和 `</html>`，保留 `<head>` + `<body>` |
| **混合型**（有 `<head>` + `<body>`）                | 无需修改，直接使用                                       |
| **片段型**（只有 `<style>` + `<div>` + `<script>`） | 用 `<head>` 包裹 `<style>`，用 `<body>` 包裹其余内容     |

> **注意**：即使不删除 `<html>` 标签也能正常工作（浏览器容错性强），但结构上会产生"套娃"嵌套。

### 2. 上传到 GitHub

1. 将处理好的代码保存为 `.html` 文件
2. 上传到 GitHub 公开仓库
3. 获取 jsDelivr CDN 链接：
   ```
   https://testingcf.jsdelivr.net/gh/用户名/仓库名/文件路径.html
   ```

---

## 三、正则配置

### 查找正则表达式

自定义一个触发标签，例如：

```
<DarkBramblePlayer/>
```

### 替换内容（完整7行）

```

```

<body>
<script>
  $('body').load('https://testingcf.jsdelivr.net/gh/用户名/仓库名/文件路径.html')
</script>
</body>
```
```

### 结构说明

| 部分                  | 作用                                                              |
| --------------------- | ----------------------------------------------------------------- |
| ` ``` `               | Markdown 代码块标记                                               |
| `<body>`              | ① 触发词（让插件识别为前端代码）<br>② 作为 `$('body')` 的挂载目标 |
| `<script>`            | 执行 JavaScript                                                   |
| `$('body').load(url)` | 从 CDN 拉取 HTML 并替换 body 内容                                 |

---

## 四、工作流程

```
触发 → 替换 → 加载 → 运行
```

1. **触发**：酒馆接收到消息，正则匹配到标签（如 `<DarkBramblePlayer/>`）
2. **替换**：标签被替换为加载器代码块
3. **加载**：酒馆助手检测到 `<body` 触发词，进入渲染模式，执行 `load()` 从 CDN 获取远程代码
4. **运行**：远程代码替换 body 内容，组件开始运行

---

## 五、注意事项

### CDN 缓存

jsDelivr 有缓存机制，更新 GitHub 后可能需要几分钟才能生效。

强制刷新缓存方法：使用带版本号的链接

```
https://testingcf.jsdelivr.net/gh/用户名/仓库名@main/文件路径.html
```

### 正则必须带 `<body>` 标签

原因：

1. `<body` 是触发词，让酒馆助手识别为前端代码
2. `$('body')` 需要一个 `<body>` 元素作为挂载目标

---

## 六、适用场景

任何需要动态加载、方便更新的前端组件：

- 状态栏
- 播放器
- 动态立绘
- 小工具面板
- 等等

---

## 七、快速参考

### 通用正则模板

**查找**：`<你的标签名/>`

**替换**：

```

```

<body>
<script>
  $('body').load('https://testingcf.jsdelivr.net/gh/你的用户名/你的仓库名/你的文件.html')
</script>
</body>
```
```
