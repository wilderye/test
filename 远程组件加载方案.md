# 通用远程组件加载方案（CDN 版）

## 一、原理

利用酒馆助手插件对 Markdown 代码块的渲染能力，通过正则替换注入一段"通用加载器"代码。该加载器使用 jQuery 的 `load()` 方法，从 jsDelivr CDN 镜像站拉取任意 HTML 组件代码，并注入到页面中执行。

### 酒馆助手渲染触发条件

代码块内容必须包含以下**任意一个**字符串才会被识别为前端代码：

| 触发字符串 | 示例                             |
| ---------- | -------------------------------- |
| `html>`    | `<html>` 或 `</html>`            |
| `<head>`   | `<head>`                         |
| `<body`    | `<body>` 或 `<body class="...">` |

> **核心代码**（来自 `src/util/is_frontend.ts`）：
>
> ```typescript
> export function isFrontend(content: string) {
>   return ["html>", "<head>", "<body"].some((tag) => content.includes(tag));
> }
> ```

---

## 二、准备工作

### 1. 组件代码处理

| 原始格式                                            | 处理方式                                                 |
| --------------------------------------------------- | -------------------------------------------------------- |
| **完整 HTML**（有 `<html>` 标签）                   | 建议删除 `<html>` 和 `</html>`，保留 `<head>` + `<body>` |
| **混合型**（有 `<head>` + `<body>`）                | 无需修改，直接使用                                       |
| **片段型**（只有 `<style>` + `<div>` + `<script>`） | 用 `<head>` 包裹 `<style>`，用 `<body>` 包裹其余内容     |

> **注意**：即使不删除 `<html>` 标签也能正常工作（浏览器容错性强），但结构上会产生"套娃"嵌套。

### 2. 上传到 GitHub

1. 将处理好的代码保存为 `.html` 文件
2. 上传到 GitHub 公开仓库
3. 获取 jsDelivr CDN 链接：
   ```
   https://testingcf.jsdelivr.net/gh/用户名/仓库名/文件路径.html
   ```

### 3. 如何更新组件（网页端操作）

如果你不使用 IDE，可以直接在 GitHub 网页端修改文件：

1. **进入编辑模式**：打开你的文件，点击右上角的 **✏️ 铅笔图标** (Edit file)。
2. **修改代码**：直接在网页编辑器中修改代码。
3. **提交更改**：点击右上角的 **Commit changes...** 按钮。
4. **选择提交方式**：
   - ✅ **Commit directly to the main branch**（直接提交到主分支）：**选这个！** 这是最快的方式，适合个人维护的小项目。
   - ❌ **Create a new branch...**（创建新分支并发起合并请求）：这是多人协作时的流程，自己改代码不需要选这个。
5. 点击绿色 **Commit changes** 按钮确认。

---

## 三、正则配置

### 查找正则表达式

自定义一个触发标签，例如：

```
<DarkBramblePlayer/>
```

### 替换内容（完整7行）

```

```

<body>
<script>
  $('body').load('https://testingcf.jsdelivr.net/gh/用户名/仓库名/文件路径.html')
</script>
</body>
```
```

### 结构说明

| 部分                  | 作用                                                              |
| --------------------- | ----------------------------------------------------------------- |
| ` ``` `               | Markdown 代码块标记                                               |
| `<body>`              | ① 触发词（让插件识别为前端代码）<br>② 作为 `$('body')` 的挂载目标 |
| `<script>`            | 执行 JavaScript                                                   |
| `$('body').load(url)` | 从 CDN 拉取 HTML 并替换 body 内容                                 |

---

## 四、工作流程

```
触发 → 替换 → 加载 → 运行
```

1. **触发**：酒馆接收到消息，正则匹配到标签（如 `<DarkBramblePlayer/>`）
2. **替换**：标签被替换为加载器代码块
3. **加载**：酒馆助手检测到 `<body` 触发词，进入渲染模式，执行 `load()` 从 CDN 获取远程代码
4. **运行**：远程代码替换 body 内容，组件开始运行

---

## 五、注意事项

### CDN 缓存与版本控制

jsDelivr 会缓存你的文件。如果你刚更新了 GitHub，但酒馆里还是旧版，这是因为 CDN 还没刷新。

#### 解决方法：使用带版本号的链接

在 URL 中仓库名后面加上 `@版本` 即可。

1.  **引用分支（开发用）**：

    ```
    https://testingcf.jsdelivr.net/gh/用户名/仓库名@main/文件路径.html
    ```

    - `@main` 表示引用主分支的最新代码。
    - 注意：即使加了 `@main`，CDN 也可能有短暂缓存。

2.  **引用具体提交（强制刷新 - 最稳）**：

    ```
    https://testingcf.jsdelivr.net/gh/用户名/仓库名@8a2b3c/文件路径.html
    ```

    - `@8a2b3c` 是你 GitHub 提交记录（Commit）的哈希值前几位。
    - **原理**：每次提交的哈希值都不一样，CDN 会把它当作一个全新的文件，绝对不会有缓存问题。
    - **获取方式**：在 GitHub 文件页面的右上角 History 或 commits 中可以看到一串字符（如 `8a2b3c4...`），复制前 7 位即可。

3.  **引用发行版（稳定版）**：

    ```
    https://testingcf.jsdelivr.net/gh/用户名/仓库名@v1.0/文件路径.html
    ```

    - 如果你在 GitHub 发布了 Release（发行版），可以用标签名。适合发布给别人用的稳定版本。

#### 最佳实践建议

- **给用户的正则**：使用 **`@main`** 或 **`@v1.0`**（稳定版）。
  - **优点**：用户只需要配置一次正则，以后你更新 GitHub，用户的酒馆会自动（延迟）获取新版，**完全不需要用户手动去改正则**。
  - **缺点**：你推送代码后，用户可能要等一段时间（通常几分钟到几小时）才能看到变化。这是正常的 CDN 缓存机制。

- **你自己测试**：使用 **`@commit哈希`**。
  - **场景**：当你刚改完代码，想立刻在酒馆里看效果，又不想等缓存刷新时，临时改一下你自己酒馆里的正则链接。测试没问题了，再推送到 GitHub，用户那边慢慢就会生效。

### 正则必须带 `<body>` 标签

原因：

1. `<body` 是触发词，让酒馆助手识别为前端代码
2. `$('body')` 需要一个 `<body>` 元素作为挂载目标

---

## 六、适用场景

任何需要动态加载、方便更新的前端组件：

- 状态栏
- 播放器
- 动态立绘
- 小工具面板
- 等等

---

## 七、快速参考

### 通用正则模板

**查找**：`<你的标签名/>`

**替换**：

```

```

<body>
<script>
  $('body').load('https://testingcf.jsdelivr.net/gh/你的用户名/你的仓库名/你的文件.html')
</script>
</body>
```
```
```dy>
<script>
  $('body').load('https://testingcf.jsdelivr.net/gh/你的用户名/你的仓库名/你的文件.html')
</script>
</body>
```
```
```
```
```
