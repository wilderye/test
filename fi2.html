<html lang="zh-CN">
  <head>
    <style>
      @import url('https://fontsapi.zeoseven.com/256/main/result.css');

      body {
        font-family: 'Huiwen-mincho';
        font-weight: normal;
      }
      /* CSS变量将通过JS动态设置 */
      :root {
        --fire-scale: 0.5;
        --qqflins-image: url();
      }
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }

      .lamp-wrapper {
        transition:
          transform 0.3s ease,
          opacity 0.3s ease;
        pointer-events: none;
      }

      .lamp-wrapper:hover:not(.shrunk) {
        opacity: 0.8;
      }

      .lamp-container {
        position: relative;
        width: 200px;
        height: 300px;
        transform-origin: bottom center;
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        cursor: pointer;
        z-index: 99;
        pointer-events: auto;
      }

      .lamp-wrapper.shrunk .lamp-container {
        transform: scale(0.4);
        transition: all 0.3s ease;
      }

      .lamp-wrapper.shrunk:hover .lamp-container {
        opacity: 0.8;
      }

      .lamp-animation {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform-origin: bottom center;
        animation:
          lamp-sway-horizontal 4s ease-in-out infinite,
          lamp-sway-vertical 2.5s ease-in-out infinite;
        pointer-events: none;
      }

      .lamp-wrapper.shrunk .lamp-animation {
        animation:
          lamp-sway-horizontal-shrunk 4s ease-in-out infinite,
          lamp-sway-vertical-shrunk 2.5s ease-in-out infinite;
      }

      /* .lamp-wrapper.shrunk:hover .lamp-animation {
        animation: lamp-sway-horizontal-shrunk-hover 4s ease-in-out infinite,
          lamp-sway-vertical-shrunk-hover 2.5s ease-in-out infinite;
      } */
      .fire-container {
        position: absolute;
        left: 50%;
        transform: translateX(-50%) scale(var(--fire-scale));
        top: 0px;
        width: 120px;
        height: 230px;
        transform-origin: 50% 90%;
        pointer-events: none;
      }
      .lamp {
        z-index: 99;
        height: 300px;
        background-image: url('https://files.catbox.moe/hp9wpx.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        position: relative;
        pointer-events: none;
      }
      .lamp-bg {
        position: absolute;
        left: 50%;
        transform: translateX(-50%) translateY(-20%);
        width: 200px;
        height: 300px;
        background: radial-gradient(rgb(45, 82, 191) 0%, rgb(44, 48, 122) 60%);
        border-radius: 50% 50% 50% 50%;
        filter: blur(40px);
        z-index: -1;
        pointer-events: none;
        transition:
          opacity 0.3s ease,
          visibility 0.3s ease;
      }

      .lamp-bg.hide {
        opacity: 0;
        visibility: hidden;
      }

      .flame {
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 70px;
        height: 120px;
        background: linear-gradient(to top, #1e90ff 0%, #4169e1 40%, #4a0dad 70%, #5034f147 100%);
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        animation:
          flicker 0.3s ease-in-out infinite alternate,
          sway 2s ease-in-out infinite;
        box-shadow:
          0 0 30px #4169e1,
          0 0 50px #520dad,
          0 0 70px #5100ff;
        filter: blur(8px);
      }

      .flame::before {
        content: '';
        position: absolute;
        top: 10%;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 115px;
        background: linear-gradient(to top, #4169e1 0%, #00bfff 50%, #b0e0e6 100%);
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        animation: flicker 0.4s ease-in-out infinite alternate;
        filter: blur(6px);
      }

      .flame::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateX(-50%);
        width: 30px;
        height: 60px;
        background: linear-gradient(to top, #00bfff 0%, #add8e6 50%, #f0f8ff 100%);
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        animation: flicker 0.2s ease-in-out infinite alternate;
        filter: blur(4px);
      }

      .spark {
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 3px;
        height: 3px;
        background: #add8e6;
        border-radius: 50%;
        animation: rise 1.5s ease-out infinite;
        box-shadow: 0 0 8px #00bfff;
        filter: blur(1px);
        z-index: 999;
        pointer-events: none;
      }

      .spark:nth-child(2) {
        animation-delay: 0.3s;
        left: 40%;
      }

      .spark:nth-child(3) {
        animation-delay: 0.6s;
        left: 60%;
      }

      .spark:nth-child(4) {
        animation-delay: 0.9s;
        left: 35%;
      }

      .spark:nth-child(5) {
        animation-delay: 1.2s;
        left: 65%;
      }

      @keyframes flicker {
        0% {
          transform: translateX(-50%) scaleY(1) scaleX(1);
          opacity: 1;
        }
        100% {
          transform: translateX(-50%) scaleY(1.1) scaleX(0.95);
          opacity: 0.9;
        }
      }

      @keyframes sway {
        0%,
        100% {
          transform: translateX(-50%) skewX(0deg);
        }
        25% {
          transform: translateX(-50%) skewX(3deg);
        }
        75% {
          transform: translateX(-50%) skewX(-3deg);
        }
      }

      @keyframes lamp-sway-horizontal {
        0%,
        100% {
          transform: rotate(0deg) translateX(0);
        }
        50% {
          transform: rotate(1.5deg) translateX(1px);
        }
      }

      @keyframes lamp-sway-vertical {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-5px);
        }
      }

      @keyframes lamp-sway-horizontal-shrunk {
        0%,
        100% {
          transform: rotate(0deg) translateX(0);
        }
        50% {
          transform: rotate(3deg) translateX(1px);
        }
      }

      @keyframes lamp-sway-vertical-shrunk {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }

      @keyframes lamp-sway-horizontal-shrunk-hover {
        0%,
        100% {
          transform: rotate(0deg) translateX(0);
        }
        50% {
          transform: rotate(3.15deg) translateX(1.05px);
        }
      }

      @keyframes lamp-sway-vertical-shrunk-hover {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-4.2px);
        }
      }

      @keyframes rise {
        0% {
          transform: translateY(0) translateX(0);
          opacity: 1;
        }
        100% {
          transform: translateY(-300px) translateX(calc(var(--random) * 30px));
          opacity: 0;
        }
      }

      .status-panel,
      .status-bg {
        position: fixed;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 1.5s cubic-bezier(0.4, 0, 0.2, 1),
          visibility 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1;
      }

      .status-panel {
        top: 30%;
        height: 380px;
        pointer-events: auto;
        width: 350px;
      }

      .status-bg {
        top: 35%;
        height: 500px;
        width: 300px;
        background-image: url('https://files.catbox.moe/qju9w8.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        pointer-events: none;
      }

      .status-panel.show {
        opacity: 1;
        visibility: visible;
        z-index: 98;
        display: flex;
        align-items: center;
      }

      .status-bg.show {
        opacity: 1;
        visibility: visible;
        z-index: -1;
      }

      .status-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        --twinkle-delay: 0s;
        --twinkle-duration: 4s;
        overflow: visible;
      }

      .status-item:nth-child(odd) {
        align-items: flex-start;
        text-align: left;
        padding-left: 0px;
      }

      .status-item:nth-child(even) {
        align-items: flex-end;
        text-align: right;
        padding-right: 0px;
      }

      .status-title {
        font-family: 'Huiwen-mincho', sans-serif;
        font-size: 14px;
        color: rgb(89, 244, 254);
        text-shadow:
          0 0 8px rgba(71, 86, 186, 0.9),
          0 0 12px rgba(44, 48, 122, 0.6);
        font-weight: 500;
        animation: statusTwinkle var(--twinkle-duration) ease-in-out infinite;
        animation-delay: calc(var(--twinkle-delay) + 0.2s);
      }

      .status-item:nth-child(odd) .status-title {
        padding-left: 48px;
      }

      .status-item:nth-child(even) .status-title {
        padding-right: 48px;
      }

      .status-content {
        font-family: 'Huiwen-mincho', sans-serif;
        font-size: 13px;
        color: #f0f0f0;
        text-shadow:
          0 0 6px rgba(71, 86, 186, 0.9),
          0 0 10px rgba(44, 48, 122, 0.6);
        line-height: 1.4;
        width: 80%;
        animation: statusTwinkle var(--twinkle-duration) ease-in-out infinite;
        animation-delay: var(--twinkle-delay);
      }

      .status-item:nth-child(odd) .status-content {
        padding-left: 0px;
      }

      .status-item:nth-child(even) .status-content {
        padding-right: 0px;
      }

      .status-item.no-title .status-content {
        margin-top: 0;
      }
      .status-container {
        position: relative;
        width: 100%;
        height: 500px;
        justify-content: center;
        align-items: flex-end;
        display: flex;
        perspective: 900px;
        transform-style: preserve-3d;
        overflow: visible;
      }
      /* 3D 透视用可组合变换（不影响原有缩放/动画） */
      .lamp-wrapper {
        --lx: 0px;
        --ly: 0px;
        --lz: 0px;
        --lrx: 0deg;
        --lry: 0deg;
        --lscale: 1;
        transform: translateY(-20%) translate3d(var(--lx), var(--ly), var(--lz)) rotateX(var(--lrx)) rotateY(var(--lry))
          scale(var(--lscale));
        will-change: transform;
      }

      .status-panel {
        --px: 0px;
        --py: 0px;
        --pz: 0px;
        --prx: 0deg;
        --pry: 0deg;
        transform: translateX(-50%) translateY(-35%) translate3d(var(--px), var(--py), var(--pz)) rotateX(var(--prx))
          rotateY(var(--pry));
        will-change: transform;
      }
      .status-bg {
        --bx: 0px;
        --by: 0px;
        --bz: 0px;
        --brx: 0deg;
        --bry: 0deg;
        transform: translateX(-50%) translateY(-35%) translate3d(var(--bx), var(--by), var(--bz)) rotateX(var(--brx))
          rotateY(var(--bry));
        will-change: transform;
      }
      /* 心情符号气泡样式 */
      .mood-container {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-flow: column;
        margin-top: 16px;
        padding-bottom: 40px;
      }

      .mood-bubble {
        background: rgba(71, 86, 186, 0.3);
        border: 2px dashed rgba(89, 244, 254, 0.5);
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 16px;
        color: #f0f0f0;
        text-shadow: 0 0 8px rgba(89, 244, 254, 0.9);
        box-shadow: 0 0 15px rgba(71, 86, 186, 0.4);
        animation:
          bubbleFloat 3s ease-in-out infinite,
          statusTwinkle 4s ease-in-out infinite;
        white-space: nowrap;
        max-width: 100px;
      }

      .mood-bubble::before {
        content: '';
        position: absolute;
        left: 50%;
        bottom: -10px;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 10px solid rgba(89, 244, 254, 0.5);
      }

      @keyframes bubbleFloat {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-5px);
        }
      }
      .qqflins {
        margin-top: 5px;
        width: 100px;
        height: 100px;
        background-image: var(--qqflins-image);
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        cursor: pointer;
        transition: transform 0.22s cubic-bezier(0.22, 1.28, 0.36, 1);
        will-change: transform;
        pointer-events: auto;
      }

      .qqflins:hover {
        animation: mood-bounce-smooth 0.7s cubic-bezier(0.22, 1.28, 0.36, 1);
      }

      @keyframes mood-bounce-smooth {
        0% {
          transform: scale(1);
        }
        20% {
          transform: scale(1.15, 0.88);
        }
        40% {
          transform: scale(0.92, 1.18);
        }
        60% {
          transform: scale(1.06, 0.96);
        }
        80% {
          transform: scale(0.98, 1.02);
        }
        100% {
          transform: scale(1);
        }
      }
      .status-contents {
        align-self: center;
        width: 350px;
        height: 380px;
        padding: 40px 35px;
        box-sizing: border-box;
        overflow-y: scroll;
        display: flex;
        flex-direction: column;
        gap: 16px;
        align-self: flex-end;
        z-index: 98;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
        scroll-behavior: smooth;
        perspective: 1000px;
        transform-style: preserve-3d;
        -webkit-mask-image: linear-gradient(
          to bottom,
          transparent 0%,
          /* 顶部完全透明 */ black 10px,
          /* 经过 px 过渡到完全不透明 */ black calc(100% - 10px),
          /* 底部向上 px 处保持完全不透明 */ transparent 100%
        );
        mask-image: linear-gradient(
          to bottom,
          transparent 0,
          /* 顶部完全透明 */ black 10px,
          /* 经过 px 过渡到完全不透明 */ black calc(100% - 10px),
          transparent 100%
        );
      }

      .status-contents::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }

      .status-item {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: center;
      }
      .status-item:hover {
        scale: 1.05;
        opacity: 1 !important;
      }
      @keyframes statusTwinkle {
        0% {
          opacity: 0.82;
          text-shadow:
            0 0 4px rgba(71, 86, 186, 0.6),
            0 0 8px rgba(44, 48, 122, 0.4);
        }
        40% {
          opacity: 1;
          text-shadow:
            0 0 10px rgba(89, 244, 254, 0.9),
            0 0 16px rgba(44, 48, 122, 0.7);
        }
        60% {
          opacity: 0.9;
          text-shadow:
            0 0 6px rgba(71, 86, 186, 0.7),
            0 0 12px rgba(44, 48, 122, 0.5);
        }
        100% {
          opacity: 0.85;
          text-shadow:
            0 0 5px rgba(71, 86, 186, 0.55),
            0 0 9px rgba(44, 48, 122, 0.35);
        }
      }
      .status-item:nth-child(1) {
        --twinkle-delay: 0.1s;
        --twinkle-duration: 3.6s;
      }
      .status-item:nth-child(2) {
        --twinkle-delay: 0.9s;
        --twinkle-duration: 4.3s;
      }
      .status-item:nth-child(3) {
        --twinkle-delay: 1.7s;
        --twinkle-duration: 3.8s;
      }
      .status-item:nth-child(4) {
        --twinkle-delay: 0.5s;
        --twinkle-duration: 4.6s;
      }
      .status-item:nth-child(5) {
        --twinkle-delay: 1.3s;
        --twinkle-duration: 3.4s;
      }
      .status-item:nth-child(6) {
        --twinkle-delay: 2.1s;
        --twinkle-duration: 4.8s;
      }
      .status-item:nth-child(7) {
        --twinkle-delay: 0.7s;
        --twinkle-duration: 3.9s;
      }
      .status-item:nth-child(8) {
        --twinkle-delay: 1.9s;
        --twinkle-duration: 4.2s;
      }
      .status-item:nth-child(9) {
        --twinkle-delay: 0.3s;
        --twinkle-duration: 3.5s;
      }
      .status-item:nth-child(10) {
        --twinkle-delay: 1.5s;
        --twinkle-duration: 4.7s;
      }
      .status-item:nth-child(11) {
        --twinkle-delay: 2.3s;
        --twinkle-duration: 3.7s;
      }
      .status-item:nth-child(12) {
        --twinkle-delay: 0.8s;
        --twinkle-duration: 4.4s;
      }
    </style>
  </head>
  <body>
    <div class="status-container">
      <div class="lamp-bg"></div>
      <div class="lamp-wrapper">
        <div class="lamp-container">
          <div class="lamp-animation">
            <div class="lamp"></div>
            <div class="fire-container">
              <div class="flame"></div>
            </div>
            <div class="spark" style="--random: 1"></div>
            <div class="spark" style="--random: -1"></div>
            <div class="spark" style="--random: 0.5"></div>
            <div class="spark" style="--random: -0.5"></div>
            <div class="spark" style="--random: 0"></div>
          </div>
        </div>
      </div>
      <div class="status-bg"></div>
      <div class="status-panel">
        <div class="status-contents">
          <div class="status-item">
            <div class="status-title">好感度</div>
            <div class="status-content" id="favorability-display" style="cursor: pointer">
              <span id="favorability-text"></span>
              <span id="favorability-trend"></span>
            </div>
          </div>
          <div class="status-item">
            <div class="status-title">当前关系</div>
            <div class="status-content" id="status-relation"></div>
          </div>
          <div class="status-item">
            <div class="status-title">时间</div>
            <div class="status-content" id="status-time"></div>
          </div>
          <div class="status-item">
            <div class="status-title">位置</div>
            <div class="status-content" id="status-location"></div>
          </div>
          <div class="status-item">
            <div class="status-title">外在人格</div>
            <div class="status-content" id="status-outer-personality"></div>
          </div>
          <div class="status-item">
            <div class="status-title">内在人格</div>
            <div class="status-content" id="status-inner-personality"></div>
          </div>
          <div class="status-item">
            <div class="status-title">私欲</div>
            <div class="status-content" id="status-desire"></div>
          </div>
          <div class="status-item">
            <div class="status-title">姿态</div>
            <div class="status-content" id="status-posture"></div>
          </div>
          <div class="status-item">
            <div class="status-title">衣着</div>
            <div class="status-content" id="status-clothing"></div>
          </div>
          <div class="status-item">
            <div class="status-title">想法</div>
            <div class="status-content" id="status-thought"></div>
          </div>
          <div class="mood-container">
            <div class="mood-bubble" id="status-mood"></div>
            <div class="qqflins"></div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // 使用 substitudeMacros 替换所有宏并初始化内容
      (function initMacros() {
        // 设置 CSS 变量
        const favorability = substitudeMacros('{{format_message_variable::stat_data.菲林斯.好感度}}');
        const moodImage = substitudeMacros('{{format_message_variable::stat_data.菲林斯.心情图片}}');
        document.documentElement.style.setProperty('--fire-scale', `calc(${favorability}/100)`);
        document.documentElement.style.setProperty('--qqflins-image', `url(${moodImage})`);

        // 设置 HTML 内容
        document.getElementById('favorability-trend').textContent = substitudeMacros(
          '{{format_message_variable::stat_data.菲林斯.好感趋势}}',
        );
        document.getElementById('status-relation').textContent = substitudeMacros(
          '{{format_message_variable::stat_data.菲林斯.当前关系}}',
        );
        document.getElementById('status-time').textContent = substitudeMacros(
          '{{format_message_variable::stat_data.菲林斯.状态.时间}}',
        );
        document.getElementById('status-location').textContent = substitudeMacros(
          '{{format_message_variable::stat_data.菲林斯.状态.位置}}',
        );
        document.getElementById('status-outer-personality').textContent = substitudeMacros(
          '{{format_message_variable::stat_data.菲林斯.心理.外在人格}}',
        );
        document.getElementById('status-inner-personality').textContent = substitudeMacros(
          '{{format_message_variable::stat_data.菲林斯.心理.内在人格}}',
        );
        document.getElementById('status-desire').textContent = substitudeMacros(
          '{{format_message_variable::stat_data.菲林斯.心理.私欲}}',
        );
        document.getElementById('status-posture').textContent = substitudeMacros(
          '{{format_message_variable::stat_data.菲林斯.状态.姿态}}',
        );
        document.getElementById('status-clothing').textContent = substitudeMacros(
          '{{format_message_variable::stat_data.菲林斯.状态.衣着}}',
        );
        document.getElementById('status-thought').textContent = substitudeMacros(
          '{{format_message_variable::stat_data.菲林斯.心理.想法}}',
        );
        document.getElementById('status-mood').textContent = substitudeMacros(
          '{{format_message_variable::stat_data.菲林斯.状态.心情符号}}',
        );
      })();

      const lampWrapper = document.querySelector('.lamp-wrapper');
      const lampContainer = document.querySelector('.lamp-container');
      const statusPanel = document.querySelector('.status-panel');
      const statusBg = document.querySelector('.status-bg');
      const lampBg = document.querySelector('.lamp-bg');
      let isShrunk = false;

      lampContainer.addEventListener('click', function () {
        if (!isShrunk) {
          // 同时缩小灯和显示面板
          lampWrapper.classList.add('shrunk');
          lampBg.classList.add('hide');
          setTimeout(() => {
            statusPanel.classList.add('show');
          }, 500);
          statusBg.classList.add('show');
          isShrunk = true;
        } else {
          // 同时收起面板和恢复灯
          statusPanel.classList.remove('show');
          setTimeout(() => {
            statusBg.classList.remove('show');
          }, 500);
          lampWrapper.classList.remove('shrunk');
          lampBg.classList.remove('hide');
          isShrunk = false;
        }
      });
      // 3D 立体透视交互
      (function () {
        const container = document.querySelector('.status-container');
        const lampLayer = document.querySelector('.lamp-wrapper');
        const panelLayer = document.querySelector('.status-panel');
        const bgLayer = document.querySelector('.status-bg');
        if (!container || !lampLayer || !panelLayer || !bgLayer) return;
        let rafId = null;
        let target = { x: 0, y: 0 };
        let current = { x: 0, y: 0 };
        const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
        const lerp = (a, b, t) => a + (b - a) * t;
        function onMove(e) {
          const rect = container.getBoundingClientRect();
          const cx = rect.left + rect.width / 2;
          const cy = rect.top + rect.height / 2;
          const dx = (e.clientX - cx) / rect.width; // -0.5..0.5
          const dy = (e.clientY - cy) / rect.height; // -0.5..0.5
          target.x = clamp(dx * 2, -1, 1);
          target.y = clamp(dy * 2, -1, 1);
          if (!rafId) rafId = requestAnimationFrame(update);
        }
        function onLeave() {
          target.x = 0;
          target.y = 0;
          if (!rafId) rafId = requestAnimationFrame(update);
        }
        function update() {
          current.x = lerp(current.x, target.x, 0.12);
          current.y = lerp(current.y, target.y, 0.12);
          // 前景（灯）强，中文字中等，背景弱
          // 灯层
          lampLayer.style.setProperty('--lx', `${current.x * 12}px`);
          lampLayer.style.setProperty('--ly', `${current.y * 10}px`);
          lampLayer.style.setProperty('--lz', `60px`);
          lampLayer.style.setProperty('--lry', `${current.x * 10}deg`);
          lampLayer.style.setProperty('--lrx', `${-current.y * 8}deg`);
          // 文字层
          panelLayer.style.setProperty('--px', `${current.x * 7}px`);
          panelLayer.style.setProperty('--py', `${current.y * 6}px`);
          panelLayer.style.setProperty('--pz', `30px`);
          panelLayer.style.setProperty('--pry', `${current.x * 6}deg`);
          panelLayer.style.setProperty('--prx', `${-current.y * 4}deg`);
          // 背景层（更远，幅度更小，稍微反向或同向均可，这里选同向更自然）
          bgLayer.style.setProperty('--bx', `${current.x * 3}px`);
          bgLayer.style.setProperty('--by', `${current.y * 2}px`);
          bgLayer.style.setProperty('--bz', `-60px`);
          bgLayer.style.setProperty('--bry', `${current.x * 3}deg`);
          bgLayer.style.setProperty('--brx', `${-current.y * 2}deg`);
          if (Math.abs(current.x - target.x) > 0.001 || Math.abs(current.y - target.y) > 0.001) {
            rafId = requestAnimationFrame(update);
          } else {
            rafId = null;
          }
        }
        container.addEventListener('mousemove', onMove);
        container.addEventListener('mouseleave', onLeave);
      })();

      // 滚动球面效果
      (function () {
        const container = document.querySelector('.status-contents');
        if (!container) return;

        function updateItemsScale() {
          const items = container.querySelectorAll('.status-item');
          const containerRect = container.getBoundingClientRect();
          const centerY = containerRect.top + containerRect.height / 2;

          items.forEach(item => {
            const itemRect = item.getBoundingClientRect();
            const itemCenterY = itemRect.top + itemRect.height / 2;
            const distanceY = itemCenterY - centerY;
            const maxDistance = containerRect.height / 2;

            // 归一化距离 -1 到 1
            const normalizedDistance = distanceY / maxDistance;

            // 计算缩放比例：中心为1.2，边缘为0.85
            const absDistance = Math.abs(normalizedDistance);
            const scale = Math.max(0.85, 1.2 - absDistance * 0.35);

            // 计算透明度：中心为1，边缘为0.5
            const opacity = Math.max(0.5, 1 - absDistance * 0.5);

            // 计算球面弧度：上方向上弯，下方向下弯
            const rotateX = normalizedDistance * -25; // 最大旋转25度

            // 计算Z轴位移，制造球面深度效果
            const translateZ = -Math.abs(normalizedDistance) * 30; // 边缘向后退30px

            // 组合变换
            item.style.transform = `
              perspective(800px)
              translateZ(${translateZ}px)
              rotateX(${rotateX}deg)
              scale(${scale})
            `;
            item.style.opacity = opacity;
          });
        }

        // 监听滚动事件
        container.addEventListener('scroll', updateItemsScale);

        // 初始更新
        updateItemsScale();

        // 面板显示时也更新
        const observer = new MutationObserver(mutations => {
          mutations.forEach(mutation => {
            if (mutation.attributeName === 'class') {
              const panel = mutation.target;
              if (panel.classList.contains('show')) {
                setTimeout(updateItemsScale, 100);
              }
            }
          });
        });

        const statusPanel = document.querySelector('.status-panel');
        if (statusPanel) {
          observer.observe(statusPanel, { attributes: true });
        }
      })();

      // 好感度文本切换功能
      (function () {
        const favorabilityDisplay = document.getElementById('favorability-display');
        const favorabilityText = document.getElementById('favorability-text');

        // 从模板变量中提取好感度数值
        const favorabilityStr = substitudeMacros('{{format_message_variable::stat_data.菲林斯.好感度}}');
        const favorabilityMatch = favorabilityStr.match(/\d+/);
        const favorabilityValue = favorabilityMatch ? parseInt(favorabilityMatch[0]) : 0;

        let showingText = true;

        // 根据数值返回对应文本
        function getFavorabilityText(value) {
          if (value < 20) return '初行邂逅';
          if (value < 40) return '幽火微明';
          if (value < 70) return '长夜共话';
          if (value < 90) return '寂静回响';
          return '苍焰为契';
        }

        // 设置初始显示为文本
        favorabilityText.textContent = getFavorabilityText(favorabilityValue);

        // 点击切换
        favorabilityDisplay.addEventListener('click', function (e) {
          if (showingText) {
            favorabilityText.textContent = '　　　' + favorabilityValue.toString();
          } else {
            favorabilityText.textContent = getFavorabilityText(favorabilityValue);
          }
          showingText = !showingText;
        });
      })();
    </script>
  </body>
</html>
