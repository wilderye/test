<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>望息 - 状态栏 (响应式)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg-main: #ffffff;
        --bg-panel: #f9fafb;
        --border-color: #e5e7eb;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --accent-pressure: #a3b1c6;
        --accent-acceptance: #f7c4c4;
        --accent-awakening-start: #a3b1c6;
        --accent-awakening-end: #f7c4c4;
        --font-main:
          'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Noto Sans SC',
          'Microsoft YaHei', sans-serif;
        --font-mono: 'Fira Code', 'Consolas', monospace;
      }
      body {
        font-family: var(--font-main);
        background-color: transparent;
        color: var(--text-primary);
        margin: 0;
        padding: 0;
        font-size: 14px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .status-container {
        background-color: var(--bg-main);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        margin: 10px 0;
        box-sizing: border-box;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
        overflow: hidden;
      }
      .global-info-bar {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        padding-bottom: 16px;
        margin-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9em;
        color: var(--text-secondary);
      }
      .global-info-bar .info-value {
        font-weight: 500;
        color: var(--text-primary);
        padding-left: 8px;
      }
      .global-info-bar .info-location {
        white-space: normal;
      }
      .core-status-section {
        padding: 8px 0 16px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 16px;
      }
      .awakening-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 6px;
      }
      .awakening-title {
        font-size: 1.15em;
        font-weight: bold;
      }
      .awakening-stage {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9em;
        color: var(--text-secondary);
        font-style: italic;
      }
      .stage-icon {
        width: 1.2em;
        height: 1.2em;
        position: relative;
        top: 2px;
      }
      .progress-bar-container {
        background-color: #f3f4f6;
        height: 12px;
        width: 100%;
        border-radius: 6px;
        margin-bottom: 4px;
        overflow: hidden;
      }
      .progress-bar-value {
        height: 100%;
        width: 0%;
        transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        border-radius: 6px;
        background: linear-gradient(to right, var(--accent-awakening-start), var(--accent-awakening-end));
      }
      .progress-value-wrapper {
        display: flex;
        justify-content: flex-end;
        align-items: baseline;
        gap: 6px;
        margin-top: 6px;
        position: relative;
        top: 1px;
      }
      .progress-value-text {
        font-size: 0.85em;
        color: var(--text-secondary);
      }
      .progress-value-change {
        font-size: 0.8em;
        font-style: italic;
        color: var(--text-secondary);
      }
      .mindset-section {
        margin-top: 20px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      .mindset-item {
        display: flex;
        flex-direction: column;
      }
      .mindset-header {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        font-size: 0.9em;
        margin-bottom: 6px;
        align-items: center;
      }
      .mindset-title {
        font-weight: 500;
        text-align: left;
      }
      .mindset-value {
        color: var(--text-secondary);
        text-align: right;
        font-size: 0.9em;
        position: relative;
        top: 1px;
      }
      .mini-progress-bar-container {
        background-color: #f3f4f6;
        height: 6px;
        width: 100%;
        border-radius: 3px;
        overflow: hidden;
      }
      .mini-progress-bar-value {
        height: 100%;
        width: 0%;
        border-radius: 3px;
        transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1);
      }
      #pressure-bar {
        background-color: var(--accent-pressure);
      }
      #acceptance-bar {
        background-color: var(--accent-acceptance);
      }
      .info-group {
        background-color: transparent;
        border: none;
        border-bottom: 1px solid var(--border-color);
        border-radius: 0;
        overflow: hidden;
        margin-bottom: 0;
      }
      .info-group:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }
      .info-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 12px;
        cursor: pointer;
        transition: background-color 0.2s ease-out;
        border-radius: 8px;
      }
      .info-group-header:hover {
        background-color: rgba(0, 0, 0, 0.04);
      }
      .info-group-title,
      .npc-name-title {
        font-size: 1em;
        font-weight: 500;
        color: var(--text-primary);
      }
      .info-group-toggle {
        font-size: 1em;
        transition: transform 0.3s ease;
        color: var(--text-secondary);
      }
      .info-group-header.open .info-group-toggle {
        transform: rotate(180deg);
      }
      .info-group-content {
        display: grid;
        grid-template-rows: 0fr;
        transition: grid-template-rows 0.35s ease-out;
        background-color: transparent;
      }
      .info-group-content.open {
        grid-template-rows: 1fr;
      }
      .content-wrapper {
        overflow: hidden;
        min-height: 0;
        padding: 0 20px;
      }
      .content-wrapper > .info-item:first-child {
        padding-top: 10px;
      }
      .content-wrapper > .info-item:last-child {
        padding-bottom: 14px;
      }
      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 4px;
        border-bottom: 1px solid #f3f4f6;
        font-size: 0.9em;
      }
      .content-wrapper .info-item:last-child,
      .info-group-content .info-item:last-child {
        border-bottom: none;
      }
      .info-key {
        color: var(--text-secondary);
        flex-shrink: 0;
        white-space: nowrap;
        margin-right: 16px;
      }
      .info-value {
        font-weight: 500;
        text-align: right;
      }
      @media (min-width: 600px) {
        .global-info-bar {
          display: grid;
          grid-template-columns: 1fr auto 1fr;
          flex-direction: row;
          align-items: center;
          gap: 16px;
        }
        .global-info-bar > div:nth-child(1) {
          text-align: left;
        }
        .global-info-bar > div:nth-child(2) {
          text-align: center;
        }
        .global-info-bar > div:nth-child(3) {
          text-align: right;
        }
        .global-info-bar .info-location {
          white-space: nowrap;
        }
        .mindset-section {
          grid-template-columns: 1fr 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="status-container" id="status-container"></div>

    <script>
      let statDataCache = null;
      let lastMessageId = null;

      function SafeGetValue(obj, path, defaultValue = 'N/A') {
        if (!obj || typeof path !== 'string') return defaultValue;
        const keys = path.split('.');
        let current = obj;
        for (const key of keys) {
          if (current === null || typeof current !== 'object' || !current.hasOwnProperty(key)) return defaultValue;
          current = current[key];
        }
        if (current === undefined || current === null) return defaultValue;
        return current;
      }

      function getAwakeningStage(value) {
        if (value >= 80) {
          return '孤岛王国';
        } else if (value >= 60) {
          return '共生藤蔓';
        } else if (value >= 30) {
          return '摇摆天平';
        } else if (value >= 10) {
          return '割裂囚笼';
        } else {
          return '惊蛰余波';
        }
      }

      function createInfoItem(key, value) {
        return `<div class="info-item"><span class="info-key">${key}</span><span class="info-value">${value}</span></div>`;
      }

      function createGenericGroup(title, contentHTML, isNpcTitle = false) {
        const titleClass = isNpcTitle ? 'npc-name-title' : 'info-group-title';
        return `
            <div class="info-group">
                <div class="info-group-header">
                    <span class="${titleClass}">${title}</span>
                    <span class="info-group-toggle">▼</span>
                </div>
                <div class="info-group-content">
                    <div class="content-wrapper">${contentHTML}</div>
                </div>
            </div>`;
      }

      function buildClothingInfo(data) {
        let html = '';
        if (!data || typeof data !== 'object') return createInfoItem('数据', '不可用');
        const clothingOrder = ['上衣', '下衣', '内衣', '内裤', '袜子', '鞋子', '配饰'];
        clothingOrder.forEach(key => {
          if (data.hasOwnProperty(key)) {
            const value = SafeGetValue(data, key, '无');
            let displayValue = value;
            if (Array.isArray(value)) {
              const items = value.filter(v => v !== '$__META_EXTENSIBLE__$');
              displayValue = items.length > 0 ? items.join(', ') : '无';
            }
            html += createInfoItem(key, displayValue);
          }
        });
        return html;
      }

      function createNpcCard(npcName, npcData) {
        let contentHTML = '';
        const identity = SafeGetValue(npcData, '身份', {});
        contentHTML += createInfoItem('公开身份', SafeGetValue(identity, '公开身份'));
        contentHTML += createInfoItem('隐藏身份', SafeGetValue(identity, '隐藏身份'));
        const personality = SafeGetValue(npcData, '性格', []);
        const personalityText = Array.isArray(personality) ? personality.join(', ') : 'N/A';
        contentHTML += createInfoItem('性格', personalityText);
        const userName = substitudeMacros('{{user}}');
        contentHTML += createInfoItem(`对${userName}好感度`, SafeGetValue(npcData, `对${userName}好感度`));
        contentHTML += createInfoItem(`与${userName}关系`, SafeGetValue(npcData, `与${userName}关系`));

        const clothingData = SafeGetValue(npcData, '衣着', {});
        const clothingHTML = createGenericGroup('衣着', buildClothingInfo(clothingData));
        return createGenericGroup(npcName, contentHTML + clothingHTML, true);
      }

      function initializeAccordions() {
        document.querySelectorAll('.info-group-header').forEach(header => {
          header.addEventListener('click', () => {
            const content = header.nextElementSibling;
            if (!content) return;
            header.classList.toggle('open');
            content.classList.toggle('open');
          });
        });
      }

      async function renderConsole() {
        const currentLastMessageId = getCurrentMessageId();
        if (currentLastMessageId === lastMessageId && statDataCache) return;
        lastMessageId = currentLastMessageId;

        const container = document.getElementById('status-container');
        if (!container) return;

        try {
          const messages = await getChatMessages(currentLastMessageId);
          const gameData = messages[0]?.data;
          if (!gameData || !gameData.stat_data) {
            container.innerHTML = `<div style="text-align:center; padding: 20px; color: var(--text-secondary);">状态数据未就绪。</div>`;
            return;
          }
          const statData = gameData.stat_data;
          statDataCache = statData;

          let prevStatData = null;
          if (currentLastMessageId > 0) {
            try {
              const prevMessages = await getChatMessages(currentLastMessageId - 1);
              prevStatData = prevMessages[0]?.data?.stat_data;
            } catch (e) {
              console.log('无法获取上一条消息，可能已经是第一条。');
            }
          }

          let finalHTML = '';

          const year = SafeGetValue(statData, '世界.当前年份');
          const date = SafeGetValue(statData, '世界.日期');
          const weekday = SafeGetValue(statData, '世界.星期');
          const fullDateDisplay = `${year} ${date} ${weekday}`;

          const fullLocation = [
            SafeGetValue(statData, '世界.地点.省份'),
            SafeGetValue(statData, '世界.地点.市'),
            SafeGetValue(statData, '世界.地点.具体地点'),
          ]
            .filter(Boolean)
            .join(' ');

          finalHTML += `
                <div class="global-info-bar">
                    <div>日期:<span class="info-value">${fullDateDisplay}</span></div>
                    <div>时间:<span class="info-value">${SafeGetValue(statData, '世界.时间')}</span></div>
                    <div class="info-location">地点:<span class="info-value">${fullLocation}</span></div>
                </div>`;

          finalHTML += `<div class="core-status-section">`;

          const awakeningValue = parseFloat(SafeGetValue(statData, '望息.觉醒值', 0));
          const prevAwakeningValue = prevStatData
            ? parseFloat(SafeGetValue(prevStatData, '望息.觉醒值', awakeningValue))
            : awakeningValue;
          const awakeningDiff = awakeningValue - prevAwakeningValue;

          let diffText = '';
          if (Math.abs(awakeningDiff) > 0.01) {
            diffText = `<span class="progress-value-change">(${awakeningDiff > 0 ? '+' : ''}${awakeningDiff.toFixed(1)})</span>`;
          }

          const awakeningStageName = getAwakeningStage(awakeningValue);
          const isStageUnlocked = SafeGetValue(statData, `望息.阶段锁.${awakeningStageName}`, false);
          const stageIconSrc = isStageUnlocked
            ? 'https://api.iconify.design/fluent/eye-24-regular.svg?color=%23111827'
            : 'https://api.iconify.design/ph/eye-closed-bold.svg?color=%236b7280';

          finalHTML += `
                <div class="awakening-header">
                    <span class="awakening-title">觉醒值</span>
                    <span class="awakening-stage">
                        <img src="${stageIconSrc}" alt="阶段状态" class="stage-icon">
                        <span>${awakeningStageName}</span>
                    </span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-value" style="width: ${awakeningValue}%;"></div>
                </div>
                <div class="progress-value-wrapper">
                    <div class="progress-value-text">${awakeningValue.toFixed(1)} / 100</div>
                    ${diffText}
                </div>`;

          const mindset = SafeGetValue(statData, '望息.心态', {});
          const pressure = parseInt(SafeGetValue(mindset, '内在压力', 0), 10);
          const acceptance = parseInt(SafeGetValue(mindset, '外部接纳', 0), 10);
          finalHTML += `
                <div class="mindset-section">
                    <div class="mindset-item">
                        <div class="mindset-header">
                            <span class="mindset-title">内在压力</span>
                            <span class="mindset-value">${pressure} / 100</span>
                        </div>
                        <div class="mini-progress-bar-container">
                            <div id="pressure-bar" class="mini-progress-bar-value" style="width: ${pressure}%;"></div>
                        </div>
                    </div>
                    <div class="mindset-item">
                        <div class="mindset-header">
                            <span class="mindset-title">外部接纳</span>
                            <span class="mindset-value">${acceptance} / 100</span>
                        </div>
                        <div class="mini-progress-bar-container">
                            <div id="acceptance-bar" class="mini-progress-bar-value" style="width: ${acceptance}%;"></div>
                        </div>
                    </div>
                </div>`;

          finalHTML += `</div>`;

          const userNameForGroup = substitudeMacros('{{user}}');
          const userPosture = SafeGetValue(statData, `${userNameForGroup}.姿势`, '无');
          let userPostureHTML = createInfoItem('姿势', userPosture);
          let userClothingHTML = buildClothingInfo(SafeGetValue(statData, `${userNameForGroup}.衣着`, {}));
          finalHTML += createGenericGroup(userNameForGroup, userPostureHTML + userClothingHTML);

          const mochiPosture = SafeGetValue(statData, '望息.姿势', '无');
          let mochiPostureHTML = createInfoItem('姿势', mochiPosture);
          let mainCharacterClothingHTML = buildClothingInfo(SafeGetValue(statData, '望息.衣着', {}));
          finalHTML += createGenericGroup('望息', mochiPostureHTML + mainCharacterClothingHTML);

          const npcs = SafeGetValue(statData, 'NPCs', {});
          const activeNpcs = Object.keys(npcs).filter(
            key => key !== '$meta' && SafeGetValue(npcs, `${key}.最近出场`) === true,
          );
          let npcContentHTML = '';
          if (activeNpcs.length > 0) {
            activeNpcs.forEach(npcName => {
              npcContentHTML += createNpcCard(npcName, npcs[npcName]);
            });
          } else {
            npcContentHTML = `<div style="text-align:center; padding: 12px 0; color: var(--text-secondary);">当前无活跃角色。</div>`;
          }
          finalHTML += createGenericGroup('其他活跃角色', npcContentHTML);

          container.innerHTML = finalHTML;

          initializeAccordions();
        } catch (error) {
          console.error('状态栏渲染出错:', error);
          container.innerHTML = `<div style="text-align:center; padding: 20px; color: #EF4444;">状态栏渲染出错: ${error.message}</div>`;
        }
      }

      let isRendering = false;
      async function debouncedRender() {
        if (isRendering) return;
        isRendering = true;
        try {
          await renderConsole();
        } finally {
          setTimeout(() => {
            isRendering = false;
          }, 100);
        }
      }

      eventOn(tavern_events.MESSAGE_SWIPED, debouncedRender);
      eventOn(tavern_events.MESSAGE_EDITED, debouncedRender);
      eventOn('chat_updated', debouncedRender);

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', debouncedRender);
      } else {
        debouncedRender();
      }
    </script>
  </body>
</html>
